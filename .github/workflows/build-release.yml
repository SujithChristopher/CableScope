name: Build and Release CableScope

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required for creating releases

jobs:
  # Test job runs first - Windows only with Python 3.12
  test:
    name: Test on Windows - Python 3.12
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: Windows-pip-3.12-${{ hashFiles('python_gui/requirements.txt') }}
        restore-keys: |
          Windows-pip-3.12-
          Windows-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r python_gui/requirements.txt

    - name: Test Python imports
      run: |
        cd python_gui
        python -c "import PySide6; print('PySide6 OK')"
        python -c "import pyqtgraph; print('pyqtgraph OK')"
        python -c "import serial; print('serial OK')"
        python -c "import numpy; print('numpy OK')"
        python -c "import toml; print('toml OK')"
        python -c "import requests; print('requests OK')"

    - name: Test module imports
      run: |
        cd python_gui
        python -c "from core.config_manager import ConfigManager; print('ConfigManager OK')"
        python -c "from core.serial_manager import SerialCommunicationManager; print('SerialManager OK')"
        python -c "from core.error_handler import ErrorHandler; print('ErrorHandler OK')"
        python -c "from core.arduino_cli_manager import ArduinoCliManager; print('ArduinoCliManager OK')"
        python -c "from gui.tabs.control_plots_tab import ControlPlotsTab; print('ControlPlotsTab OK')"
        python -c "from gui.tabs.pwm_only_tab import PWMOnlyTab; print('PWMOnlyTab OK')"
        python -c "from gui.tabs.settings_tab import SettingsTab; print('SettingsTab OK')"
        python -c "from gui.tabs.firmware_tab import FirmwareTab; print('FirmwareTab OK')"

    - name: Verify firmware resources
      run: |
        cd python_gui
        python -c "from core.firmware_resources import get_available_firmware_types, get_firmware_content; types = get_available_firmware_types(); print(f'Found {len(types)} firmware types: {types}')"

    - name: Test GUI instantiation
      run: |
        cd python_gui
        python -c "from PySide6.QtWidgets import QApplication; import sys; app = QApplication(sys.argv); print('GUI instantiation OK')"

  build:
    needs: test  # Only build if tests pass
    name: Build Windows Release - Python 3.12
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.12
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        architecture: x64

    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~\AppData\Local\pip\Cache
        key: Windows-pip-3.12-${{ hashFiles('python_gui/requirements.txt') }}
        restore-keys: |
          Windows-pip-3.12-
          Windows-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r python_gui/requirements.txt
        pip install pyinstaller

    - name: Test Python imports
      run: |
        cd python_gui
        python -c "import PySide6; print('PySide6 OK')"
        python -c "import pyqtgraph; print('pyqtgraph OK')"
        python -c "import serial; print('serial OK')"

    - name: Build with PyInstaller
      run: |
        cd python_gui
        python -m PyInstaller cablescope.spec --clean --noconfirm
        dir dist
        if (Test-Path "dist/CableScope") {
          Compress-Archive -Path dist/CableScope -DestinationPath ../CableScope-Windows-x64.zip
        } else {
          Write-Error "Build directory not found"
          exit 1
        }
      shell: pwsh

    - name: Verify build output
      run: |
        dir
        if (Test-Path "CableScope-Windows-x64.zip") {
          Write-Host "Windows build successful"
        } else {
          Write-Host "Windows build failed"
          exit 1
        }
      shell: pwsh

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: CableScope-Windows-x64
        path: CableScope-Windows-x64.zip

    - name: Prepare release asset
      run: |
        echo "ASSET_NAME=CableScope-Windows-x64.zip" >> $env:GITHUB_ENV
        echo "ASSET_PATH=CableScope-Windows-x64.zip" >> $env:GITHUB_ENV

  # Create release if triggered by tag
  create-release:
    if: startsWith(github.ref, 'refs/tags/')
    needs: build
    runs-on: ubuntu-latest
    steps:
    - name: Download Windows artifact
      uses: actions/download-artifact@v4
      with:
        name: CableScope-Windows-x64
        path: .
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: CableScope ${{ github.ref_name }}
        body: |
          ## CableScope Motor Control System ${{ github.ref_name }}

          ### What's New
          - PWM Only tab for simple PWM firmware testing with 24h endurance runs
          - Complete motor control system with real-time plotting
          - Arduino CLI auto-download functionality (no manual setup required)
          - Enhanced CSV recording with desired vs actual torque tracking
          - Unified control and plotting interface
          - Teensy 4.1 support with optimized communication protocol
          - Support for PWM_Constant and PWM_On_Off firmwares

          ### Installation
          1. Download CableScope-Windows-x64.zip
          2. Extract and run CableScope.exe
          3. Arduino CLI will be downloaded automatically on first use

          ### Hardware Requirements
          - Teensy 4.1 (recommended) or Arduino variants
          - HX711 torque sensor (pins 32/33)
          - Quadrature encoder (pins 27/28)
          - Motor driver with PWM control (pins 8/9/10)

          ### Documentation
          See README.md for complete setup instructions.
        files: |
          CableScope-*.zip
          CableScope-*.tar.gz
        draft: false
        prerelease: false
        
